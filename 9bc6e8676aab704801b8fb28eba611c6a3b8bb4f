{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "a2030c47_bf23b3ac",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1334152
      },
      "writtenOn": "2024-01-25T09:48:13Z",
      "side": 1,
      "message": "This is fantastic, thanks for looking into it!\n\nHowever, I\u0027m not sure your test is sufficient because:\n\n1. There\u0027s a \"hidden\" (because.... reasons) sub-provider that\u0027s needed for some KeyStore functionality.  See https://r.android.com/2096606 so please check `KeyStorePkcs7FormatTest` passes before submitting.\n2. There are funky ways to configure Ciphers that may access classes which aren\u0027t advertised (e.g. you can get a \"raw\" AES instance and then configure its mode and padding later) I don\u0027t _think_ that involves reflection but to be on the safe side you probably want to run all the `javax.crypto` tests (libcore, Harmony and Conscrypt - at the very least, the Conscrypt `CipherTest`)\n3. Just because the class is advertised, doesn\u0027t mean it can be instantiated, and I don\u0027t fully trust our test coverage (e.g. (1) above didn\u0027t get noticed for years), so maybe add a small test along the lines of:\n```\nProvider provider \u003d Security.getProvider(\"BC\");\nfor (Service service : provider.getServices() {\n  service.getInstance(null);  // Might need to be `this` for some services, e.g. Signatures\n}\n```",
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d637cafe_de2c84c7",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1334152
      },
      "writtenOn": "2024-01-25T09:50:30Z",
      "side": 1,
      "message": "(sorry, shouldn\u0027t have sent that as resolved)",
      "parentUuid": "a2030c47_bf23b3ac",
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ccd785d9_80687a8e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-01-29T18:26:10Z",
      "side": 1,
      "message": "Thanks for the tips! I\u0027d like to run as many tests as possible that exercise these algorithms, so let me know if you can think of more.\n\n\u003e so please check KeyStorePkcs7FormatTest passes before submitting.\n\nDone. Added all algorithms mentioned in `addPrivateAlgorithm` calls.\n\n\u003e you probably want to run all the javax.crypto tests (libcore, Harmony and Conscrypt - at the very least, the Conscrypt CipherTest)\n\nDone, but not without errors. They\u0027re not regressions by this CL though (see also heavy presubmits).\n\nAren\u0027t the Conscrypt tests going through [`bouncycastle*unbundled`](https://cs.android.com/android/platform/superproject/main/+/main:external/conscrypt/Android.bp;l\u003d669-671;drc\u003d57c7bbf8b28ad965736b75f19257b209802fef1e)? Doesn\u0027t that mean they\u0027ll use a different bouncycastle than the shrunk one in the BCP?\n\n\u003e maybe add a small test along the lines of: /.../\n\nSure. I reckon it should go into CTS and MTS, but where should I put it?",
      "parentUuid": "d637cafe_de2c84c7",
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "8ede1810_a6badaf3",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1334152
      },
      "writtenOn": "2024-01-29T18:57:15Z",
      "side": 1,
      "message": "\u003e Done, but not without errors. They\u0027re not regressions by this CL though (see also heavy presubmits).\n\nSounds fine.  Some of our test certificates exploded over the weekend which probably didn\u0027t help. :/\n\n\n\u003e Aren\u0027t the Conscrypt tests going through [`bouncycastle*unbundled`](https://cs.android.com/android/platform/superproject/main/+/main:external/conscrypt/Android.bp;l\u003d669-671;drc\u003d57c7bbf8b28ad965736b75f19257b209802fef1e)? Doesn\u0027t that mean they\u0027ll use a different bouncycastle than the shrunk one in the BCP?\n\nNope ðŸ˜Š\n\nConscrypt tests do indeed link against that, but only for test support use.\n\nThe code being tested comes via the public JCA APIs (e.g. `Cipher.getInstance()`), and so it\u0027s testing whatever is on the boot classpath.\n\nIt\u0027s used in things like CipherTest where all installed Providers of each algorithm get tested to ensure they give the same results.\n\n\n\u003e Sure. I reckon it should go into CTS and MTS, but where should I put it?\n\n`libcore.java.security.ProviderTest`?  It actually makes sense to do this for all providers and it\u0027s possible that test does it already, I didn\u0027t check too closely.",
      "parentUuid": "ccd785d9_80687a8e",
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a320ac2e_5a00f258",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 3
      },
      "lineNbr": 0,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-01-30T15:29:16Z",
      "side": 1,
      "message": "Thanks for the explanations. I\u0027ve added a test in https://r.android.com/2937059, PTAL.",
      "parentUuid": "8ede1810_a6badaf3",
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "12e41e8a_53e2c3dd",
        "filename": "Android.bp",
        "patchSetId": 3
      },
      "lineNbr": 115,
      "author": {
        "id": 1047684
      },
      "writtenOn": "2024-01-25T16:35:29Z",
      "side": 1,
      "message": "Does it mean that classes and methods are not renamed?",
      "range": {
        "startLine": 115,
        "startChar": 8,
        "endLine": 115,
        "endChar": 25
      },
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "93db66b1_2330a3fd",
        "filename": "Android.bp",
        "patchSetId": 3
      },
      "lineNbr": 115,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-01-29T18:26:10Z",
      "side": 1,
      "message": "Yes, according to the docs. However, enabling it doesn\u0027t have any effect - the classes.dex file doesn\u0027t change at all (and I see classes in there that don\u0027t match `keep` patterns). I don\u0027t know why (`-whyareyoukeeping` doesn\u0027t say).\n\nEven if it had effect, I\u0027ll keep it disabled for now, since we\u0027ll need to make the mapping file available to not obfuscate stack traces.",
      "parentUuid": "12e41e8a_53e2c3dd",
      "range": {
        "startLine": 115,
        "startChar": 8,
        "endLine": 115,
        "endChar": 25
      },
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "67bab8d9_f5765868",
        "filename": "proguard.flags",
        "patchSetId": 3
      },
      "lineNbr": 143,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-01-25T01:04:30Z",
      "side": 1,
      "message": "@prb@google.com Can we do something to avoid this? Could these tests (or perhaps just some of them) be better off as unit tests rather than in MTS?",
      "range": {
        "startLine": 142,
        "startChar": 0,
        "endLine": 143,
        "endChar": 69
      },
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1dd9e5d0_b6a4ed12",
        "filename": "proguard.flags",
        "patchSetId": 3
      },
      "lineNbr": 143,
      "author": {
        "id": 1334152
      },
      "writtenOn": "2024-01-25T09:48:13Z",
      "side": 1,
      "message": "@vichang@google.com probably has more insight into the tests, but if the class is only being included because we have a test for it, then we can probably just delete the test.\n\nOn the other hand I\u0027m a bit surprised that the `math.ec` and `util` stuff isn\u0027t used.",
      "parentUuid": "67bab8d9_f5765868",
      "range": {
        "startLine": 142,
        "startChar": 0,
        "endLine": 143,
        "endChar": 69
      },
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "b34f3783_4dd9ca21",
        "filename": "proguard.flags",
        "patchSetId": 3
      },
      "lineNbr": 143,
      "author": {
        "id": 1047684
      },
      "writtenOn": "2024-01-25T16:35:29Z",
      "side": 1,
      "message": "In principle, I agree that we shouldn\u0027t include the dead code that only exists for tests. But mainline EngProd asks us to raise the code coverage by running tests as MTS. If we remove the tests from MTS, does it lower the code coverage?\n\nbtw, do you know if these bouncycastle classes are dead code? Or these rules only stop R8 from renaming the classes / methods / fields?",
      "parentUuid": "1dd9e5d0_b6a4ed12",
      "range": {
        "startLine": 142,
        "startChar": 0,
        "endLine": 143,
        "endChar": 69
      },
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "63b32153_5fc09e26",
        "filename": "proguard.flags",
        "patchSetId": 3
      },
      "lineNbr": 143,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-01-29T18:26:10Z",
      "side": 1,
      "message": "I think the tests could be in MTS if we link the lib statically. However, then it needs to be jarjar\u0027ed as well to avoid conflict with the BCP, right? Then that wouldn\u0027t work for coverage (at least not without special shenanigans I\u0027m not familiar with).\n\nIn any case, if we regress there it\u0027s a deficiency in the coverage testing infra, isn\u0027t it?\n\n\u003e btw, do you know if these bouncycastle classes are dead code? Or these rules only stop R8 from renaming the classes / methods / fields?\n\nThey appear to be dead. All of them I got from test failure messages from `MtsLibcoreBouncyCastleTestCases`, and since R8 does dead code removal but not renaming here they shouldn\u0027t be used by any of the `-keep` rule algorithms (unless there\u0027s more reflection I\u0027ve missed).\n\nNB, I haven\u0027t checked this again after adding the internal algorithms Pete mentioned, so some of these things may be referenced now.",
      "parentUuid": "b34f3783_4dd9ca21",
      "range": {
        "startLine": 142,
        "startChar": 0,
        "endLine": 143,
        "endChar": 69
      },
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e9a13e7_e0029b15",
        "filename": "proguard.flags",
        "patchSetId": 3
      },
      "lineNbr": 143,
      "author": {
        "id": 1373864
      },
      "writtenOn": "2024-01-31T10:56:47Z",
      "side": 1,
      "message": "Had to add a few more keeps for tests of `CertBlocklist` and some digest hash algorithms in `CtsLibcoreTestCases` - see the bottom of the file. They\u0027re not official APIs, but are there still reasons to keep them? Can they be in a hiddenapi greylist?\n\nI\u0027ll submit as-is, but I\u0027ll probably come back to this since there\u0027s ~80 KB to gain here.",
      "parentUuid": "63b32153_5fc09e26",
      "range": {
        "startLine": 142,
        "startChar": 0,
        "endLine": 143,
        "endChar": 69
      },
      "revId": "9bc6e8676aab704801b8fb28eba611c6a3b8bb4f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}